name: WebEncoder CI

on:
  workflow_dispatch:
  push:
  pull_request:

jobs:
  # Сборка backend
  build-backend:
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: backend

    steps:
      - name: Получение кода
        uses: actions/checkout@v4

      - name: Установка JDK
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Компиляция
        run: mvn -q clean compile

  # Тесты CaesarCipher
  test-caesar:
    runs-on: ubuntu-latest
    needs: build-backend

    defaults:
      run:
        working-directory: backend

    steps:
      - name: Получение кода
        uses: actions/checkout@v4

      - name: Установка JDK
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Компиляция
        run: mvn -q compile

      - name: Тест 1–4 – CaesarCipher
        run: |
          cat << 'EOF' > CaesarTest.java
          import com.example.backend.crypto.CaesarCipher;

          public class CaesarTest {
              public static void main(String[] args) {

                  // Тест 1 - Шифрование английского текста
                  String enOriginal = "Test Caesar cipher.";
                  String enEncrypted = CaesarCipher.encrypt(enOriginal, 3);
                  String enExpected = "Whvw Fdhvdu flskhu.";
                  if (!enEncrypted.equals(enExpected)) {
                      throw new RuntimeException("Test 1 failed");
                  }

                  // Тест 2 - Дешифрование английского текста
                  if (!CaesarCipher.decrypt(enEncrypted, 3).equals(enOriginal)) {
                      throw new RuntimeException("Test 2 failed");
                  }

                  // Тест 3 - Шифрование русского текста
                  String ruOriginal = "Тест шифра Цезаря.";
                  String ruEncrypted = CaesarCipher.encrypt(ruOriginal, 5);
                  String ruExpected = "Чйцч энщхе Ыймехд.";
                  if (!ruEncrypted.equals(ruExpected)) {
                      throw new RuntimeException("Test 3 failed");
                  }

                  // Тест 4 - Дешифрование русского текста
                  if (!CaesarCipher.decrypt(ruEncrypted, 5).equals(ruOriginal)) {
                      throw new RuntimeException("Test 4 failed");
                  }

                  System.out.println("Caesar tests passed");
              }
          }
          EOF

          javac -cp target/classes CaesarTest.java
          java  -cp target/classes:. CaesarTest

  # Тесты RSACipher
  test-rsa:
    runs-on: ubuntu-latest
    needs: build-backend

    defaults:
      run:
        working-directory: backend

    steps:
      - name: Получение кода
        uses: actions/checkout@v4

      - name: Установка JDK
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Компиляция RSA
        run: mvn -q compile

      - name: Тест RSA
        run: |
          cat << 'EOF' > RSATest.java
          import com.example.backend.crypto.RSACipher;

          public class RSATest {
              public static void main(String[] args) throws Exception {

                  String[] messages = {
                      "Hello",
                      "Привет",
                      "1234567890",
                      "!@#$%^&*()",
                      "",
                      "Сообщение с Юникодом ץ"
                  };

                  for (String msg : messages) {
                      String decrypted = RSACipher.encryption(msg);
                      if (!msg.equals(decrypted)) {
                          throw new RuntimeException("RSA test failed");
                      }
                  }

                  System.out.println("RSA test passed");
              }
          }
          EOF

          javac -cp target/classes RSATest.java
          java  -cp target/classes:. RSATest

  # Тесты KuznechikCipher
  test-kuznechik:
    runs-on: ubuntu-latest
    needs: build-backend

    defaults:
      run:
        working-directory: backend

    steps:
      - name: Получение кода
        uses: actions/checkout@v4

      - name: Установка JDK
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Компиляция
        run: mvn -q compile

      - name: Тест Kuznechik
        run: |
          cat << 'EOF' > KuzTest.java
          import com.example.backend.crypto.KuznechikCipher;

          public class KuzTest {
              public static void main(String[] args) {

                  String input1 = "8899AABBCCDDEEFF0077665544332211";
                  String input2 = "00112233445566778899AABBCCDDEEFF";

                  String enc1 = KuznechikCipher.encrypt(input1);
                  String enc1Repeat = KuznechikCipher.encrypt(input1);
                  String enc2 = KuznechikCipher.encrypt(input2);

                  if (!enc1.equals(enc1Repeat)) {
                      throw new RuntimeException("Not deterministic");
                  }

                  if (enc1.equalsIgnoreCase(input1)) {
                      throw new RuntimeException("Encryption did not change data");
                  }

                  if (enc1.equals(enc2)) {
                      throw new RuntimeException("Different inputs same output");
                  }

                  if (!enc1.matches("[0-9A-Fa-f]+")) {
                      throw new RuntimeException("Not HEX");
                  }

                  System.out.println("Kuznechik test passed");
              }
          }
          EOF

          javac -cp target/classes KuzTest.java
          java  -cp target/classes:. KuzTest
